## åˆ›å»º React ä¸­çš„ä¸€äº›Tagæ ‡è¯†
åˆ›å»º`src/ReactWorkTags.ts` æ–‡ä»¶ï¼Œè¿™äº›å˜é‡è¡¨ç¤ºç€ç»„ä»¶çš„ç±»å‹ï¼Œè¿™é‡Œæˆ‘ä»¬æš‚æ—¶å®ç°ä¸€äº›æ¯”è¾ƒå¸¸è§çš„ç±»å‹ã€‚
```typescript

export const FunctionComponent = 0;
export const ClassComponent = 1;
export const IndeterminateComponent = 2; // Before we know whether it is function or class
export const HostRoot = 3; // Root of a host tree. Could be nested inside another node.
export const HostPortal = 4; // A subtree. Could be an entry point to a different renderer.
export const HostComponent = 5;
export const HostText = 6;
export const Fragment = 7;
export const Mode = 8;
export const ContextConsumer = 9;
export const ContextProvider = 10;
export const ForwardRef = 11;
export const Profiler = 12;
export const SuspenseComponent = 13;
export const MemoComponent = 14;
export const SimpleMemoComponent = 15;
export const LazyComponent = 16;
export const IncompleteClassComponent = 17;
export const DehydratedFragment = 18;
export const SuspenseListComponent = 19;
export const ScopeComponent = 21;
export const OffscreenComponent = 22;
export const LegacyHiddenComponent = 23;
export const CacheComponent = 24;
export const TracingMarkerComponent = 25;
```
## Fiber çš„å«ä¹‰
fiber åœ¨ React æ˜¯éå¸¸é‡è¦çš„æ¦‚å¿µï¼Œæˆ‘ä»¬åœ¨è§£é‡Š fiber æ—¶éœ€è¦ä»ä¸‰ä¸ªå±‚é¢å»è§£é‡Šå®ƒ

1.  ä½œä¸ºæ¶æ„æ¥è¯´ï¼Œä¹‹å‰React15çš„Reconcileré‡‡ç”¨é€’å½’çš„æ–¹å¼æ‰§è¡Œï¼Œæ•°æ®ä¿å­˜åœ¨é€’å½’è°ƒç”¨æ ˆä¸­ï¼Œæ‰€ä»¥è¢«ç§°ä¸ºstack Reconcilerã€‚React16çš„ReconcileråŸºäºFiberèŠ‚ç‚¹å®ç°ï¼Œè¢«ç§°ä¸ºFiber Reconcilerã€‚ 
1.  ä½œä¸ºé™æ€çš„æ•°æ®ç»“æ„æ¥è¯´ï¼Œæ¯ä¸ªFiberèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ªReact elementï¼Œä¿å­˜äº†è¯¥ç»„ä»¶çš„ç±»å‹ï¼ˆå‡½æ•°ç»„ä»¶/ç±»ç»„ä»¶/åŸç”Ÿç»„ä»¶...ï¼‰ã€å¯¹åº”çš„DOMèŠ‚ç‚¹ç­‰ä¿¡æ¯ã€‚ 
1.  ä½œä¸ºåŠ¨æ€çš„å·¥ä½œå•å…ƒæ¥è¯´ï¼Œæ¯ä¸ªFiberèŠ‚ç‚¹ä¿å­˜äº†æœ¬æ¬¡æ›´æ–°ä¸­è¯¥ç»„ä»¶æ”¹å˜çš„çŠ¶æ€ã€è¦æ‰§è¡Œçš„å·¥ä½œï¼ˆéœ€è¦è¢«åˆ é™¤/è¢«æ’å…¥é¡µé¢ä¸­/è¢«æ›´æ–°...ï¼‰ã€‚ 
> PSï¼šä»¥ä¸Šå¼•ç”¨è‡ª kasong å¤§ä½¬ã€‚ğŸ‘‰[åŸæ–‡åœ°å€](https://react.iamkasong.com/process/fiber.html#fiber%E7%9A%84%E5%90%AB%E4%B9%89)

## å†™åˆ›å»º Fiber èŠ‚ç‚¹çš„å‡½æ•°
åˆ›å»º `src/ReactFiber.ts`ï¼ˆfiber èŠ‚ç‚¹æ˜¯æ ¹æ® jsx å¯¹è±¡è¿›è¡Œåˆ›å»ºçš„ï¼‰
```typescript
import { Placement } from "./ReactFiberFlags"
import { FunctionComponent, HostComponent } from "./ReactWorkTags"
import { isFn, isStr } from "./utils"

// vnode å°±æ˜¯å½“å‰èŠ‚ç‚¹çš„ jsx å¯¹è±¡
// returnFiber å°±æ˜¯ çˆ¶fiber
export function createFiber(vnode, returnFiber) {
	const fiber: any = {
		// ç»„ä»¶ç±»å‹
		type: vnode.type,
		key: vnode.key,
		props: vnode.props,

		stateNode: null,
		// ç¬¬ä¸€ä¸ªå­ fiber
		child: null,
		// ä¸‹ä¸€ä¸ªå…„å¼Ÿ fiber
		sibling: null,
		// çˆ¶ fiber
		return: returnFiber,
		// æ ‡è®°ï¼ˆè¿™é‡Œå…ˆé»˜è®¤æ ‡è®°ä¸º Placementï¼‰
		flags: Placement,

		alternate: null,
		// è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œnull æˆ– []
		deletions: null,
		// å½“å‰ fiber æ‰€åœ¨çš„å±‚çº§çš„ index
		index: null,
	}

	const { type } = vnode

	if (isStr(type)) {
		fiber.tag = HostComponent
	} else if (isFn(type)) {
		// å‡½æ•°ç»„ä»¶ä»¥åŠç±»ç»„ä»¶éƒ½ä¼šè¢«åˆ¤æ–­ä¸º functionï¼Œä½†æš‚ä¸åšå¤„ç†
		fiber.tag = FunctionComponent
	}

	return fiber
}
```
## åŸç”Ÿç»„ä»¶çš„æ¸²æŸ“ï¼ˆå°† jsx å¤„ç†æˆ fiber ï¼‰
`src/ReactFiberReconciler.ts`
```typescript
import { createFiber, Fiber } from "./ReactFiber";
import { isArray, isStringOrNumber, updateNode } from "./utils";

// å¤„ç†åŸç”Ÿç»„ä»¶
export function updateHostComponent(workInProgress: Fiber) {

	if (!workInProgress.stateNode) {
		const element = document.createElement(workInProgress.type)

		workInProgress.stateNode = element
		// å¤„ç† props
		updateNode(element, workInProgress.props)
	}
	// å¾€ä¸‹å¤„ç†å­èŠ‚ç‚¹ï¼Œchildren æ˜¯ jsx å¯¹è±¡
	reconcileChildren(workInProgress, workInProgress.props.children)
}

export function updateFunctionComponent(workInProgress: Fiber) { }

export function updateClassComponent(workInProgress: Fiber) { }

export function updateHostTextComponent(workInProgress: Fiber) { }

export function updateFragmentComponent(workInProgress: Fiber) { }


function reconcileChildren(workInProgress: Fiber, children) {
	if (isStringOrNumber(children)) {

		return
	}
	// è¿™é‡Œå…ˆå°†å­èŠ‚ç‚¹éƒ½å½“ä½œæ•°ç»„æ¥å¤„ç†
	const newChildren: any[] = isArray(children) ? children : [children]
	// ç”¨äºä¿å­˜ä¸Šä¸ª fiber èŠ‚ç‚¹
	let previousNewFiber: Fiber = null
	for (let i = 0; i < newChildren.length; i++) {
		const newChild = newChildren[i]
		if (newChild === null) {
			// ä¼šé‡åˆ° null çš„èŠ‚ç‚¹ï¼Œç›´æ¥å¿½ç•¥å³å¯
			continue
		}
		
		const newFiber = createFiber(newChild, workInProgress)

		if (previousNewFiber === null) {
			// ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹ç›´æ¥ä¿å­˜åˆ° workInProgress ä¸Š
			workInProgress.child = newFiber
		} else {
			// åç»­éƒ½ä¿å­˜åˆ°ä¸Šä¸€ä¸ªèŠ‚ç‚¹çš„ sibling ä¸Š
			previousNewFiber.sibling = newFiber
		}
		// æ›´æ–°
		previousNewFiber = newFiber
	}
}
```
## åˆ©ç”¨æµè§ˆå™¨ç©ºé—²æ—¶é—´æ¥å¤„ç† fiber
`src/ReactFiberWorkLoop.ts`
```typescript
import { Fiber } from "./ReactFiber";
import { Placement } from "./ReactFiberFlags";
import { updateClassComponent, updateFragmentComponent, updateFunctionComponent, updateHostComponent, updateHostTextComponent } from "./ReactFiberReconciler";
import { ClassComponent, Fragment, FunctionComponent, HostComponent, HostText } from "./ReactWorkTags";

// å½“å‰æ­£åœ¨å¤„ç†çš„èŠ‚ç‚¹
let workInProgress: Fiber | null = null;

// æ ¹èŠ‚ç‚¹
let workInProgressRoot: Fiber | null = null;

// åˆæ¬¡æ¸²æŸ“å’Œæ›´æ–°
export function scheduleUpdateOnFiber(fiber) {
	workInProgress = fiber;
	workInProgressRoot = fiber
}

function performUnitOfWork() {
	const { tag } = workInProgress

	// todo 1. æ›´æ–°å½“å‰ç»„ä»¶
	switch (tag) {
		case HostComponent:
			updateHostComponent(workInProgress);
			break;

		case FunctionComponent:
			updateFunctionComponent(workInProgress);
			break;

		case ClassComponent:
			updateClassComponent(workInProgress);
			break;

		case Fragment:
			updateFragmentComponent(workInProgress);
			break;
		
		case HostText:
			updateHostTextComponent(workInProgress);
			break;
		
		default:
			break;
	}

	// todo 2. æ›´æ–°å­ç»„ä»¶ï¼ˆæ·±åº¦ä¼˜å…ˆéå†ï¼‰
	const child = workInProgress.child;
	if (child) {
		// å¤„ç†å­èŠ‚ç‚¹
		workInProgress = child;
		return
	}

	while(workInProgress) {
		if (workInProgress.sibling) {
			workInProgress = workInProgress.sibling;
			return
		}
		// æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹å°±å¾€ä¸Šå½’ä¸€å±‚ï¼Œå°è¯•å¤„ç†ä¸Šä¸€å±‚çš„å…„å¼ŸèŠ‚ç‚¹
		workInProgress = workInProgress.return;
	}
	// æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œä¹Ÿæ²¡æœ‰ä¸Šä¸€å±‚ï¼Œå°±ç»“æŸ
	workInProgress = null
}


function workLoop(IdleDeadLine: IdleDeadline) {
	while(workInProgress && IdleDeadLine.timeRemaining() > 0) {
		// å¤„ç†æˆ fiberï¼ŒæŒ‚è½½ stateNode props ç­‰æ“ä½œ
		performUnitOfWork()
	}
}

// åˆ©ç”¨ requestIdleCallback æ¥è®¡ç®—å¤„ç†
requestIdleCallback(workLoop)
```
## å¤„ç†å®Œ fiber ä»¥ååˆ›å»º dom å¹¶æ›´æ–°åˆ°çœŸå® dom ä¸Š
`src/ReactFiberWorkLoop.ts`
```typescript
function workLoop(IdleDeadLine: IdleDeadline) {
	while(workInProgress && IdleDeadLine.timeRemaining() > 0) {
		// å¤„ç†æˆ fiberï¼ŒæŒ‚è½½ stateNode props ç­‰æ“ä½œ
		performUnitOfWork()
	}

	if (!workInProgress && workInProgressRoot) {
		// workInProgress === null ä¸” workInProgressRoot å­˜åœ¨è¯´æ˜æ‰€æœ‰çš„ fiber éƒ½å¤„ç†å®Œäº†
		// éœ€è¦æ›´æ–°åˆ°é¡µé¢ä¸Š
		commitRoot()
	}
}
	
// æäº¤
function commitRoot() {
	commitWorker(workInProgressRoot)
	// æäº¤å®Œä»¥åéœ€è¦æ¸…ç©º workInProgressRoot é˜²æ­¢é‡å¤æäº¤
	workInProgressRoot = null
}


// æ·±åº¦ä¼˜å…ˆéå†
function commitWorker(workInProgress: Fiber) {
	if (!workInProgress) return
	// 1. æäº¤è‡ªå·±

	const parentNode = workInProgress.return.stateNode
	const { flags, stateNode } = workInProgress
	if (flags & Placement && stateNode) {
		parentNode.appendChild(stateNode)
	}

	// 2. æäº¤å­èŠ‚ç‚¹
	commitWorker(workInProgress.child)
	// 3. æäº¤å…„å¼ŸèŠ‚ç‚¹
	commitWorker(workInProgress.sibling)
}
```

## å®ç°å‡½æ•°ç»„ä»¶çš„æ¸²æŸ“

`src/ReactFiberReconciler.ts`

```typescript
export function updateFunctionComponent(workInProgress: Fiber) { 
	const { type, props } = workInProgress
	// type å°±æ˜¯å‡½æ•°ï¼ŒæŠŠ props ä¼ è¿‡å»å°±èƒ½æ‹¿åˆ° jsx å¯¹è±¡äº†
	const children = type(props)
	// å‘ä¸‹ reconciler
	reconcileChildren(workInProgress, children)
}
```

å‡½æ•°ç»„ä»¶æ˜¯æ²¡æœ‰ stateNode çš„ï¼Œæ‰€ä»¥åœ¨æ¸²æŸ“æ—¶ appendChild ä¼šæŠ›é”™ï¼Œé‚£è¿™é‡Œéœ€è¦æ‰¾åˆ°çœŸæ­£çš„ dom å°±éœ€è¦å¾€ä¸Šæ‰¾äº†

`src/ReactFiberWorkLoop.ts`

```typescript
 function commitWorker(workInProgress: Fiber) {
	if (!workInProgress) return
	// 1. æäº¤è‡ªå·±

	// éœ€è¦æ‰¾åˆ°å®é™…æ¸²æŸ“çš„çˆ¶èŠ‚ç‚¹
	let parentNode = getParentNode(workInProgress.return)

	const { flags, stateNode } = workInProgress
	if (flags & Placement && stateNode) {
		parentNode.appendChild(stateNode)
	}
	// 2. æäº¤å­èŠ‚ç‚¹
	commitWorker(workInProgress.child)
	// 3. æäº¤å…„å¼ŸèŠ‚ç‚¹
	commitWorker(workInProgress.sibling)
}

// å‡½æ•°ç»„ä»¶ç­‰ æ˜¯æ²¡æœ‰stateNodeï¼Œæ‰€ä»¥è¦å¾€ä¸Šæ‰¾çœŸæ­£çš„ dom èŠ‚ç‚¹
function getParentNode(fiber: Fiber) {
	let stateNode = fiber.stateNode
	while(!stateNode) {
		fiber = fiber.return
		stateNode = fiber.stateNode
	}
	return stateNode
}
```

## å®ç°ç±»ç»„ä»¶çš„æ¸²æŸ“
å› ä¸º typeof ClassComponent å’Œ FunctionComponent éƒ½æ˜¯ "function"ï¼Œæ‰€ä»¥éœ€è¦å¤„ç†ä¸€ä¸‹åˆ›å»ºå¯¹åº”çš„ fiber èŠ‚ç‚¹æ—¶æ‰“çš„ tag æ¥åŒºåˆ†è¿™ä¸¤è€…ã€‚

ClassComponent extends è‡ª React.Componentï¼Œæ‰€ä»¥æˆ‘ä»¬çš„åŒºåˆ†ç‚¹å°±åœ¨ Component çš„åŸå‹ä¸ŠåŠ ä¸ªæ ‡å¿— `isReactComponent`ï¼Œæ¥ç€åœ¨åˆ›å»º fiber æ—¶æ ¹æ®è¿™ä¸ªæ ‡å¿—æ¥åŒºåˆ†æ˜¯ FunctionComponent è¿˜æ˜¯ ClassComponent

åˆ›å»º React.Component å¹¶æ·»åŠ  Class ç»„ä»¶çš„æ ‡å¿—`src/Component.ts`
```typescript
export default functino Component(props) {
	this.props = props
}

Component.prototype.isReactComponent = true
```
æ ¹æ®åŸå‹ä¸Šçš„æ ‡å¿—åŒºåˆ† fiber çš„ç±»å‹`src/ReactFiber.ts`
```typescript

export function createFiber(vnode, returnFiber) {
	// ......

	if (isStr(type)) {
		fiber.tag = HostComponent
	} else if (isFn(type)) {
		// å‡½æ•°ç»„ä»¶ä»¥åŠç±»ç»„ä»¶éƒ½ä¼šè¢«åˆ¤æ–­ä¸º function
		// æ ¹æ®åˆ¤æ–­åŸå‹ä¸Šæ˜¯å¦æœ‰ isReactComponent æ¥åˆ¤æ–­å‡ºæ˜¯ class è¿˜æ˜¯ function çš„ç±»å‹ï¼ˆisReactComponent æ¥è‡ªäº React.Component ï¼‰
		fiber.tag = (type as Function).prototype.isReactComponent ? ClassComponent : FunctionComponent
	}
}
```

å®ç° ClassComponent çš„ reconciler`src/ReactFiberReconciler.ts`
```typescript
export function updateClassComponent(workInProgress: Fiber) {
	const { type, props } = workInProgress
	const instance = new type(props)
	// class çš„ children æ¥è‡ªäº render å‡½æ•°
	const children = instance.render()
	reconcileChildren(workInProgress, children)
}
```
## å®ç°æ–‡æœ¬ç»„ä»¶çš„æ¸²æŸ“
æ–‡æœ¬ç»„ä»¶è™½ç„¶åˆ›å»ºäº†ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡æ‰“å°çš„ fiber æ¥çœ‹ï¼Œå®ƒä¸Šé¢çš„å±æ€§å…¨éƒ¨éƒ½æ˜¯ null æˆ– undefinedï¼Œæ‰€ä»¥åœ¨ performUnitOfWork ä¸­ä¸èƒ½èµ°åˆ°å¯¹åº”çš„ç±»å‹å¤„ç†ï¼Œéœ€è¦ç»™æ–‡æœ¬ç»„ä»¶æ·»åŠ ä¸Šç±»å‹`src/ReactFiber.ts`
```typescript

export function createFiber(vnode, returnFiber) {
	// ......

	if (isStr(type)) {
		fiber.tag = HostComponent
	} else if (isFn(type)) {
		// å‡½æ•°ç»„ä»¶ä»¥åŠç±»ç»„ä»¶éƒ½ä¼šè¢«åˆ¤æ–­ä¸º function
		// æ ¹æ®åˆ¤æ–­åŸå‹ä¸Šæ˜¯å¦æœ‰ isReactComponent æ¥åˆ¤æ–­å‡ºæ˜¯ class è¿˜æ˜¯ function çš„ç±»å‹ï¼ˆisReactComponent æ¥è‡ªäº React.Component ï¼‰
		fiber.tag = (type as Function).prototype.isReactComponent ? ClassComponent : FunctionComponent
	} else if (isUndefined(type)) {
		fiber.tag = HostText
		fiber.props = {
			// ç›´æ¥å°†æ–‡æœ¬æ”¾åˆ° children ä¸Š
			children: vnode
		}
	}
}
```
è¿™æ ·å°±å¯ä»¥è¿›å…¥åˆ° `updateHostTextComponent`
æ¥ç€æˆ‘ä»¬å¤„ç†ä¸€ä¸‹æ–‡æœ¬èŠ‚ç‚¹çš„ fiberï¼Œè¿™éƒ¨åˆ†ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–‡æœ¬ï¼Œå¹¶å°†å…¶ç›´æ¥æ”¾åˆ°fiberçš„ stateNode å±æ€§ä¸Šå³å¯
`src/ReactFiberReconciler.ts`
```typescript
export function updateHostTextComponent(workInProgress: Fiber) {
	const { props } = workInProgress
	// åˆ›å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹æ”¾åˆ° stateNode ä¸Š
	workInProgress.stateNode = document.createTextNode(props.children)
}
```
è¿™æ ·æ–‡æœ¬èŠ‚ç‚¹å°±å¯ä»¥è¢«æ¸²æŸ“å‡ºæ¥äº†
## Fragmentç»„ä»¶æ¸²æŸ“
Fragment ç»„ä»¶çš„ type æ˜¯ Symbol(react.fragment)ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥è¿›å…¥åˆ°åˆ¤æ–­typeçš„ else åˆ†æ”¯å³å¯ã€‚æŒ‰ç…§ä¸Šé¢çš„å¥—è·¯ï¼ŒFragment ä¹Ÿæ˜¯åŠ ä¸Šå¯¹åº”çš„ tagï¼Œç„¶ååœ¨å¯¹åº”çš„ reconciler ä¸­è¿›è¡Œå¤„ç†`src/ReactFiber.ts`
```typescript
export function createFiber(vnode, returnFiber) {
	// ......

	if (isStr(type)) {
		fiber.tag = HostComponent
	} else if (isFn(type)) {
		fiber.tag = (type as Function).prototype.isReactComponent ? ClassComponent : FunctionComponent
	} else if (isUndefined(type)) {
		fiber.tag = HostText
		fiber.props = {
			children: vnode
		}
	} else {
		// ç›´æ¥æ‰“ä¸Š tag å³å¯
		fiber.tag = Fragment
	}
}
```
åŒæ ·ä¹Ÿæ˜¯åœ¨å¯¹åº”çš„ reconciler ä¸­å¤„ç†ä¸€ä¸‹ï¼Œè¿™é‡Œç›´æ¥è°ƒç”¨ reconcileChildren ä¼ å…¥workInProgress å’Œ children å³å¯`src/ReactFiberReconciler.ts`
```typescript
export function updateFragmentComponent(workInProgress: Fiber) {
	const { props } = workInProgress
	reconcileChildren(workInProgress, props.children)
}
```

è‡³æ­¤ï¼Œæˆ‘ä»¬å®ç°äº† React ä¸­çš„ Fiber åˆ›å»ºï¼Œä»¥åŠ ReactDOM.createRoot å’Œå¸¸ç”¨çš„å‡ ç§ç»„ä»¶æ¸²æŸ“ã€‚
åœ¨è¿™ä¸€èŠ‚å½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æµè§ˆå™¨æä¾›çš„ requestIdleCallbackï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬è‡ªå·±å®ç°ä¸€ä¸ªæ¥æ›¿ä»£å®ƒã€‚
