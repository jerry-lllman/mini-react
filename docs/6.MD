# å®ç°useEffectäºuseLayoutEffect
è¿™ä¸€èŠ‚æˆ‘ä»¬å®ç° react ä¸­çš„`useEffect`ä¸`useLayoutEffect`ã€‚
## åŒºåˆ«
`useEffect`ä¸`useLayoutEffect` çš„å‡½æ•°ç­¾åæ˜¯ä¸€è‡´çš„ï¼Œéƒ½æ¥æ”¶ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸ä¸€ä¸ªå¯é€‰çš„ä¾èµ–æ•°ç»„
```typescript
useEffect(callback, dependencies)

useLayoutEffect(callback, dependencies)
```
ä¸åŒç‚¹åœ¨äº`useEffect`æ˜¯åœ¨ï¼ˆDOMï¼‰æ•´ä½“æ›´æ–°å®Œæˆä»¥åæ‰§è¡Œ`callback`ï¼ˆä¹Ÿå°±æ˜¯æ‰€è°“çš„å¼‚æ­¥ï¼‰ã€‚è€Œ`useLayoutEffect`åˆ™åœ¨æ›´æ–°è¿‡ç¨‹ä¸­æ‰§è¡Œï¼ˆæ‰€è°“åŒæ­¥ï¼‰ã€‚
> ğŸ‘†è®°ä½ä¸Šé¢è¿™å¥è¯  ğŸ¥³

## å®ç°å›è°ƒå‡½æ•°çš„æ‰§è¡Œ
ä¸¤ä¸ªå‡½æ•°çš„`callback`éƒ½éœ€è¦æ”¾åˆ°`memoizedState`ä¸­ï¼Œå¹¶ä¸”æ·»åŠ åˆ°ä¸€ä¸ªï¼ˆ`updateQueue`çš„ï¼‰å•é“¾è¡¨ä¸Šã€‚
æˆ‘ä»¬è¿™é‡Œä¸ºäº†æ–¹ä¾¿åŒºåˆ†ï¼Œå°†è¿™ä¸ªå•é“¾è¡¨æ‹†åˆ†æˆä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨ã€‚

åœ¨`ReactFiberHooks.ts`æ–‡ä»¶ä¸­åˆ›å»ºè¿™ä¸¤ä¸ªå‡½æ•°ã€‚ä»–ä»¬æœ€ç»ˆè°ƒç”¨çš„å‡½æ•°æ˜¯`updateEffectImpl`
```typescript
function updateEffectImpl(hooksFlags, create, deps) {

}

export function useEffect(create: EffectCallback, deps?: ReadonlyArray<unknown>) {
	return updateEffectImpl(HookPassive, create, deps)
}


export function useLayoutEffect(create: EffectCallback, deps?: ReadonlyArray<unknown>) {
	return updateEffectImpl(HookLayout, create, deps)
}
```
æŒ‰ç…§æˆ‘ä»¬ä¸Šé¢è¯´çš„è¦æ±‚å®ç°`updateEffectImpl`çš„ä»£ç 
```typescript
// åœ¨ renderWithHook ä¸­åˆå§‹åŒ–è¿™ä¸¤ä¸ªæ•°ç»„ï¼ˆä»£ç ç•¥ï¼‰

// æ ¹æ® hooksFlags æ·»åŠ åˆ°ä¸åŒçš„ queue ä¸­
function updateEffectImpl(hooksFlags, create, deps) {
	const hook = updateWorkInProgressHook()
	const nextDeps = deps === undefined ? null : deps

	const effect = { hooksFlags, create, deps: nextDeps }

	hook.memoizedState = effect
	if (hooksFlags & HookPassive) {
		currentlyRenderingFiber?.updateQueueOfEffect.push(effect)
	} else if (hooksFlags & HookLayout) {
		currentlyRenderingFiber?.updateQueueOfLayout.push(effect)
	}
}
```

æ·»åŠ åˆ°queueä¸­å®ç°äº†ï¼Œæ¥ä¸‹æ¥éœ€è¦åœ¨æ°å½“çš„æ—¶æœºå»æ‰§è¡Œ`callback`ï¼Œä¹Ÿå°±æ˜¯`commit`æ—¶éœ€è¦å°†å…¶æ‰§è¡Œã€‚
```typescript
// ReactFiberWorkLoop.ts

function commitWorker(workInProgress: Fiber | null) {
  // ... æäº¤è¿‡ç¨‹
  
  // æäº¤å®Œä»¥åæ‰§è¡Œ effect çš„ callback
  // å› ä¸ºåªæœ‰ FunctionCompoent æ‰æœ‰ hookï¼Œæ‰€ä»¥éœ€è¦åˆ¤æ–­ä¸€ä¸‹
  if (workInProgress.tag === FunctionComponent) {
		invokeHooks(workInProgress)
	}

	// 2. æäº¤å­èŠ‚ç‚¹
	commitWorker(workInProgress.child)
	// 3. æäº¤å…„å¼ŸèŠ‚ç‚¹
	commitWorker(workInProgress.sibling)
}


function invokeHooks(workInProgress: Fiber) {
	const { updateQueueOfEffect, updateQueueOfLayout } = workInProgress

	// useLayoutEffect ç›´æ¥æ‰§è¡Œ
	updateQueueOfLayout.forEach(item => {
		const { create } = item
		create()
	})
	
	// useEffect çš„ callback éœ€è¦æ›´æ–°ä»¥åæ‰æ‰§è¡Œï¼Œæ‰€ä»¥éœ€è¦æ”¾åˆ° scheduler ä¸­ï¼ˆå¼‚æ­¥è°ƒç”¨ï¼‰
	updateQueueOfEffect.forEach(item => {
		const { create } = item
		scheduleCallback(() => {
			create()
		})
	})
}
```
ä¸šåŠ¡ä»£ç å¦‚ä¸‹ğŸ‘‡
```tsx
function FunctionComponent(props) {

  const [count, setCount] = useState(0)

  useEffect(() => {
    console.log('useEffect')
  })

  useLayoutEffect(() => {
    console.log('useLayoutEffect')
  })

  return (
    <div className='function'>
      <button onClick={() => setCount(count + 1)}>{count}</button>
    </div>
  )
}

```
åœ¨æµè§ˆå™¨ä¸­ï¼Œ`useEffect`å’Œ`useLayoutEffect`å¦‚æˆ‘ä»¬çš„é¢„æœŸæ‰§è¡Œäº†`callback`
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1081923/1656927109949-698daac1-e606-4191-999e-8e913dda1633.png#clientId=u46a0de32-8909-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=131&id=uf724788a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=131&originWidth=202&originalType=binary&ratio=1&rotation=0&showTitle=false&size=9212&status=done&style=none&taskId=u50463949-124a-41c2-af95-4781e987aa8&title=&width=202)
## æ ¹æ®ä¾èµ–é¡¹æ‰§è¡Œ
ä¸Šé¢çš„å®ç°è¿˜ç¼ºå°‘ä¾èµ–é¡¹çš„å¯¹æ¯”ï¼Œæˆ‘ä»¬æ·»åŠ ä¸Šä¾èµ–é¡¹çš„å¯¹æ¯”å‡½æ•°
```typescript
// ReactFiberHooks.ts
export function areHookInputsEqual(nextDeps, prevDeps) {
  // ä¸å­˜åœ¨ä¾èµ–é¡¹ï¼Œè¿”å› falsy
  if (prevDeps === null) return false
  
  for (let i = 0; i < prevDeps.length && i < nextDeps.length; i++) {
    if (Object.is(nextDeps[i], prevDeps[i])) {
      // ä¾èµ–é¡¹ä¸€è‡´ï¼Œæ£€æŸ¥ä¸‹ä¸€ä¸ª
      continue
    }
    // æŸä¸€é¡¹ä¸ä¸€è‡´ï¼Œåˆ™è¿”å› false
    return false
  }
  // ä¾èµ–é¡¹ä¸€è‡´
  return true
}
```
ä½¿ç”¨æ¯”è¾ƒä¾èµ–é¡¹å‡½æ•°ï¼Œå¦‚æœ`areHookInputsEqual`æ¯”è¾ƒä¸º`true`åˆ™ä¸å°†`callback`æ·»åŠ åˆ°`updateQueue`ä¸­
```typescript
function updateEffectImpl(hooksFlags, create, deps) { 
// æ‹¿åˆ°å½“å‰çš„è¿™ä¸ª hook
	const hook = updateWorkInProgressHook()
	const nextDeps = deps === undefined ? null : deps

  // currentHook æ˜¯ä¸Šä¸€æ¬¡ render å¯¹åº”çš„ hook
	if (currentHook) {
		const prevEffect = currentHook.memoizedState
		if (nextDeps) {
			const prevDeps = prevEffect.deps
			if (areHookInputsEqual(nextDeps, prevDeps)) {
				return
			}
		}
	}

	// æ ¹æ®å‚æ•°åˆ›å»º effect
  // ......
}
```
å–å¾—å¯¹åº”çš„ä¸Šæ¬¡ render çš„ hookâ€”â€”`currentHook`
```typescript
// å®šä¹‰ old hook
let currentHook: Hook | null = null

// åœ¨ updateWorkInProgressHook æ—¶åŒæ—¶ä¹Ÿæ›´æ–°å¯¹åº”çš„ old hook
function updateWorkInProgressHook() {
	let hook

	const current = (currentlyRenderingFiber as Fiber).alternate
	if (current) {
		(currentlyRenderingFiber as Fiber).memoizedState = current.memoizedState
		if (workInProgressHook) {
			workInProgressHook = hook = workInProgressHook.next

			// old hook ä¹Ÿéœ€è¦æ›´æ–°åˆ°å¯¹åº”çš„ old hook
			currentHook = (currentHook as Hook).next
		} else {
			workInProgressHook = hook = (currentlyRenderingFiber as Fiber).memoizedState

			// old hook ä½œä¸º head hook
			currentHook = current.memoizedState
		}
	} else {
		// ç»„ä»¶åˆæ¬¡æ¸²æŸ“

		// åˆæ¬¡æ¸²æŸ“æ—¶ä¸å­˜åœ¨ old hook
		currentHook = null
		hook = {
			memoizedState: null,
			next: null
		}
		if (workInProgressHook) {
			workInProgressHook = workInProgressHook.next = hook
		} else {
			workInProgressHook = (currentlyRenderingFiber as Fiber).memoizedState = hook
		}
	}
	return hook
}
```
`currentHook`ä¸`workInProgressHook`çš„æœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯å®ƒè®°å½•çš„æ˜¯å½“å‰ hook ä¸Šæ¬¡`render` æ—¶çš„`hook`ã€‚

è‡³æ­¤ï¼Œ`useEffect`ä¸`useLayoutEffect`ä¹Ÿå°±å®ç°å®Œæˆäº†ã€‚
